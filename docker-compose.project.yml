version: '3.8'

# Project mode: Per-directory container that mounts the current project
# Environment variables PROJECT_DIR and CONTAINER_NAME must be set

services:
  claude:
    platform: linux/arm64
    image: claude-dev-ubuntu:latest
    container_name: ${CONTAINER_NAME}
    volumes:
      # Mount the project directory
      - ${PROJECT_DIR}:/workspace/project

      # Mount setup scripts directory
      - ./setup-container:/setup-container:ro

      # Mount configuration files
      - ./config/bashrc:/etc/bash.bashrc:ro
      - ./config/starship.toml:/root/.config/starship.toml:ro
      - ./config/.gitconfig:/etc/gitconfig:ro
      - ./config/gh-config.yml:/etc/gh/config.yml:ro

      # Mount Docker socket for container operations (optional)
      - /var/run/docker.sock:/var/run/docker.sock

      # Mount Claude config from host if available
      - ${HOME}/.claude.json:/root/.claude-host.json:ro

    # Environment variables loaded via --env-file flag from claude-docker-project script
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GH_TOKEN=${GITHUB_TOKEN:-}
      - CLAUDE_CREDENTIALS=${CLAUDE_CREDENTIALS:-}
      - GIT_USER_NAME=${GIT_USER_NAME:-}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-}
      # Additional environment
      - NODE_ENV=development
      - FORCE_COLOR=true
      - IS_SANDBOX=1

    working_dir: /workspace/project
    stdin_open: true
    tty: true

    # Initialize container and keep alive
    command: |
      bash -c "
        /setup-container/setup-credentials.sh
        echo 'Container ready for project: ${PROJECT_DIR}'
        exec tail -f /dev/null
      "

    restart: "no"
