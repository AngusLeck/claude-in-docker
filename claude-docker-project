#!/bin/bash
# claude-docker-project - Run Claude in project mode
# Per-directory container that mounts current working directory

set -e

# Get directory where this script lives, resolving symlinks.
# - BASH_SOURCE[0]: path used to invoke this script (may be a symlink)
# - dirname: extracts the directory portion
# - cd && pwd: resolves to absolute path, following symlinks
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

source "$SCRIPT_DIR/lib/flags.sh"
source "$SCRIPT_DIR/lib/gum.sh"
source "$SCRIPT_DIR/lib/container.sh"

PROJECT_DIR="$(pwd)"

parse_mode_flags "$@"
set -- "${REMAINING_ARGS[@]}"

# Safety check: prevent mounting high-level directories
check_safe_directory() {
    local dir="$1"
    local depth
    depth=$(echo "$dir" | tr -cd '/' | wc -c)

    # Block root and single-level directories
    if [[ "$dir" == "/" ]]; then
        echo "Error: Cannot mount root directory. Please cd into a project directory."
        exit 1
    fi

    # Block common dangerous paths
    case "$dir" in
        /home|/Users|/root|/etc|/var|/usr|/bin|/sbin|/lib|/opt)
            echo "Error: Cannot mount system directory '$dir'. Please cd into a project directory."
            exit 1
            ;;
    esac

    # Warn on shallow directories (less than 3 levels deep)
    if [[ $depth -lt 3 ]]; then
        if ! gum_confirm "Warning: '$dir' is a high-level directory. Mount anyway?"; then
            echo "Cancelled."
            exit 1
        fi
    fi
}

check_safe_directory "$PROJECT_DIR"

# Generate deterministic container name from path
CONTAINER_HASH=$(echo "$PROJECT_DIR" | sha256sum | cut -c1-12)
CONTAINER_NAME="claude-project-${CONTAINER_HASH}"

# Determine which env file to use
if [[ -f "$HOME/.claude-in-docker/.env" ]]; then
    ENV_FILE="$HOME/.claude-in-docker/.env"
elif [[ -f "$SCRIPT_DIR/.env" ]]; then
    ENV_FILE="$SCRIPT_DIR/.env"
else
    echo "Error: No credentials found."
    echo "Either run 'install.sh' or create a .env file in $SCRIPT_DIR"
    exit 1
fi

if container_exists; then
    # Container exists - start if needed and exec
    if ! container_running; then
        echo "Starting existing container for $(basename "$PROJECT_DIR")..."
        ensure_container_running
    fi
    run_in_container "$@"
else
    # Create new container using docker-compose
    echo "Creating new container for $(basename "$PROJECT_DIR")..."

    export PROJECT_DIR
    export CONTAINER_NAME
    export ENV_FILE

    cd "$SCRIPT_DIR"
    docker-compose -f docker-compose.project.yml -p "$CONTAINER_NAME" --env-file "$ENV_FILE" up -d
    sleep 2

    run_in_container "$@"
fi
