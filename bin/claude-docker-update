#!/bin/bash
# claude-docker-update - Update claude-docker to latest version
set -e

INSTALL_DIR="$HOME/.claude-in-docker"
REPO_URL="https://github.com/AngusLeck/claude-in-docker.git"
BRANCH="${1:-master}"  # Allow specifying branch, default to main
TEMP_DIR="/tmp/claude-docker-update-$$"

echo "================================"
echo "  Claude-in-Docker Update"
echo "================================"
echo

# Cleanup on exit
cleanup() {
    rm -rf "$TEMP_DIR" 2>/dev/null || true
}
trap cleanup EXIT

# Check for git
if ! command -v git &>/dev/null; then
    echo "Error: git is required for updates"
    exit 1
fi

# Clone latest version
echo "Fetching latest version (branch: $BRANCH)..."
if ! git clone --depth 1 --branch "$BRANCH" "$REPO_URL" "$TEMP_DIR"; then
    echo "Error: Failed to clone repository"
    exit 1
fi
echo

# Backup credentials
if [[ -f "$INSTALL_DIR/.env" ]]; then
    echo "Preserving credentials..."
    cp "$INSTALL_DIR/.env" "$TEMP_DIR/.env"
fi

# Run install script
echo "Running installer..."
echo
cd "$TEMP_DIR"
./install.sh

# Cleanup happens via trap
