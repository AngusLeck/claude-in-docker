#!/bin/bash
# claude-docker-global - Run Claude in global/workspace mode
# Long-running container with persistent workspace

set -e

# Get directory where this script lives, resolving symlinks.
# - BASH_SOURCE[0]: path used to invoke this script (may be a symlink)
# - dirname: extracts the directory portion
# - cd && pwd: resolves to absolute path, following symlinks
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

source "$ROOT_DIR/lib/flags.sh"
source "$ROOT_DIR/lib/container.sh"

CONTAINER_NAME="claude-docker-global"

parse_mode_flags "$@"
set -- "${REMAINING_ARGS[@]}"

# Determine which env file to use
if [[ -f "$ROOT_DIR/.env" ]]; then
    ENV_FILE="$ROOT_DIR/.env"
else
    echo "Error: No credentials found."
    echo "Either run 'install.sh' or create a .env file in $ROOT_DIR"
    exit 1
fi

cd "$ROOT_DIR/docker"

# Ensure container is running
if ! container_running; then
    echo "Starting global Claude container..."
    docker-compose -f compose.base.yml -f compose.global.yml --env-file "$ENV_FILE" up -d
    sleep 2
fi

run_in_container "$@"
