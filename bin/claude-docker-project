#!/bin/bash
# claude-docker-project - Run Claude in project mode
# Per-directory container that mounts current working directory
# Container stops and is removed when you exit

set -e

# Get directory where this script lives, resolving symlinks.
# - BASH_SOURCE[0]: path used to invoke this script (may be a symlink)
# - dirname: extracts the directory portion
# - cd && pwd: resolves to absolute path, following symlinks
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

source "$ROOT_DIR/lib/flags.sh"
source "$ROOT_DIR/lib/gum.sh"

PROJECT_DIR="$(pwd)"

parse_mode_flags "$@"
set -- "${REMAINING_ARGS[@]}"

# Safety check: prevent mounting high-level directories
check_safe_directory() {
    local dir="$1"
    local depth
    depth=$(echo "$dir" | tr -cd '/' | wc -c)

    # Block root and single-level directories
    if [[ "$dir" == "/" ]]; then
        echo "Error: Cannot mount root directory. Please cd into a project directory."
        exit 1
    fi

    # Block common dangerous paths
    case "$dir" in
        /home|/Users|/root|/etc|/var|/usr|/bin|/sbin|/lib|/opt)
            echo "Error: Cannot mount system directory '$dir'. Please cd into a project directory."
            exit 1
            ;;
    esac

    # Warn on shallow directories (less than 3 levels deep)
    if [[ $depth -lt 3 ]]; then
        if ! gum_confirm "Warning: '$dir' is a high-level directory. Mount anyway?"; then
            echo "Cancelled."
            exit 1
        fi
    fi
}

check_safe_directory "$PROJECT_DIR"

# Determine which env file to use
if [[ -f "$HOME/.claude-in-docker/.env" ]]; then
    ENV_FILE="$HOME/.claude-in-docker/.env"
elif [[ -f "$ROOT_DIR/.env" ]]; then
    ENV_FILE="$ROOT_DIR/.env"
else
    echo "Error: No credentials found."
    echo "Either run 'install.sh' or create a .env file in $ROOT_DIR"
    exit 1
fi

export PROJECT_DIR
export ENV_FILE

# Determine command to run based on flags
if $SHELL_MODE; then
    CMD="bash"
elif $DANGEROUS_MODE; then
    CMD="claude --dangerously-skip-permissions"
else
    CMD="claude"
fi

# Run container - it will be removed when you exit
cd "$ROOT_DIR/docker"
exec docker-compose -f compose.base.yml -f compose.project.yml \
    --env-file "$ENV_FILE" \
    run --rm claude $CMD "$@"
